<html lang="en">
<head>
    <title>Main page</title>
    <style>
        table {
            border-collapse: collapse;
        }

        table, td, th {
            border: 1px solid #999;
            padding: 5px;
        }
    </style>
</head>

<body>
<div>
    <strong style="font-size: larger;">Main</strong>
</div>

<div style="margin-top: 10px;">
    <form action="/logout" method="post">
        <input type="submit" value="Sign Out"/>
    </form>
</div>

<div>
    <strong style="font-size: large;" id="user"></strong>
</div>

<div id="balance" style="margin-top: 10px;"></div>

<div style="margin-top: 10px;">
    <form method="post" action="add" id="addOperation" style="display: none">
        <label>
            <input type=text list=articles name="articles">
        </label>
        <datalist id=articles></datalist>
        <label>
            <input type="text" name="debit" placeholder="Enter debit">
        </label>
        <label>
            <input type="text" name="credit" placeholder="Enter credit">
        </label>
        <button type="submit">Add</button>
    </form>
</div>

<div>
    <form method="post" action="filter" id="filter" style="display: none">
        <label>
            <input type=text list=articles name="articles">
        </label>
        <datalist id=articles></datalist>
        <button type="submit">Find</button>
    </form>
</div>

<div>
    <form method="post" action="deleteAll" id="deleteAll" style="display: none">
        <button type="submit">deleteAll</button>
    </form>
</div>

<div>
    <form method="post" action="/api/articles" style="margin-top: 10px; display: none;" id="addArticle">
        <div>
            <label>
                <input type="text" id="article" placeholder="Enter article">
            </label>
            <button type="submit">Add Article</button>
        </div>
    </form>
</div>

<div>
    <form method="post" action="changeArticle" style="margin-top: 10px; display: none;" id="changeArticle">
        <label>
            <input type=text list=articles name="articles">
        </label>
        <datalist id=articles></datalist>
        <label>
            <input type="text" name="article" placeholder="Enter new Article">
        </label>
        <button type="submit">Change Article</button>
    </form>
</div>

{{#error}}
    <div style="margin-top: 10px;">
        <b><i>{{error}}</i></b>
    </div>
{{/error}}

<div id="articlesName"></div>

<div>
    <table id="operations" style="display: none">
        <tbody>
        <tr>
            <th>ID</th>
            <th>Article Name</th>
            <th>Debit</th>
            <th>Credit</th>
            <th>Create Date</th>
        </tr>
        </tbody>
    </table>
</div>

<!--    <div>-->
<!--        <table>-->
<!--            {#operations}}-->
<!--                <tr>-->
<!--                    <td>{id}}</td>-->
<!--                    <td>{articleName}}</td>-->
<!--                    <td>{debit}}</td>-->
<!--                    <td>{credit}}</td>-->
<!--                    <td>{create_date}}</td>-->
<!--                    <td>-->
<!--                        <form method="post" action="tableChange">-->
<!--                            <input type="hidden" name="id" value="{id}}"/>-->
<!--                            <input type="hidden" name="action" value="delete"/>-->
<!--                                    <input type="hidden" name="_csrf" value="{_csrf.token}}"/>-->
<!--                            <button type="submit">delete</button>-->
<!--                        </form>-->
<!--                    </td>-->
<!--                </tr>-->
<!--            {/operations}}-->
<!--        </table>-->
<!--    </div>-->

<script>
    window.onload = function initTable() {
        let table = document.getElementById('operations');
        let balance = document.getElementById('balance');
        let user = document.getElementById('user');
        let articles = document.getElementById('articles');
        let articlesName = document.getElementById('articlesName');

        let xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/me', false);
        xhr.send();
        let currentUser = JSON.parse(xhr.responseText);
        user.appendChild(document.createTextNode("User: " + currentUser.username));

        console.log(currentUser);

        fetch('/api/articles', {
            method: 'get'
        })
                .then(res => res.json())
                .then(function (data) {
                    console.log('Get articles request succeeded with JSON response', data);
                    restArticles = data;
                    for (let index = 0; index < data.length; index++) {
                        let toption = document.createElement("OPTION");
                        toption.appendChild(document.createTextNode(data[index].name));
                        articles.appendChild(toption);
                    }
                })
                .catch(function (error) {
                    console.log('Request failed', error);
                });
        if (currentUser.admin) {
            document.getElementById("addArticle").style.display = 'block';
            document.getElementById("changeArticle").style.display = 'block';
            fetch('/api/articles', {
                method: 'get'
            })
                    .then(res => res.json())
                    .then(function (data) {
                        console.log('Get articles request succeeded with JSON response', data);

                        data.sort(function (a, b) {
                            if (a.id > b.id) {
                                return 1;
                            }
                            if (a.id < b.id) {
                                return -1;
                            }
                            return 0;
                        });

                        for (let index = 0; index < data.length; index++) {
                            let div = document.createElement("DIV");
                            let b = document.createElement("B");
                            let articleName = document.createElement("SPAN");
                            b.appendChild(document.createTextNode(data[index].id + " "));
                            articleName.appendChild(document.createTextNode(data[index].name));
                            div.appendChild(b);
                            div.appendChild(articleName);
                            articlesName.appendChild(div);
                        }
                    })
                    .catch(function (error) {
                        console.log('Request failed', error);
                    });
        } else {
            document.getElementById("operations").style.display = 'table';
            document.getElementById("deleteAll").style.display = 'table';
            document.getElementById("filter").style.display = 'table';
            document.getElementById("addOperation").style.display = 'table';
            fetch('/api/balance/operations', {
                method: 'get'
            })
                    .then(res => res.json())
                    .then(function (data) {
                        console.log('Get operations request succeeded with JSON response', data);

                        let tbody = table.getElementsByTagName("TBODY")[0];

                        for (let index = 0; index < data.length; index++) {
                            let row = document.createElement("TR");
                            let td = document.createElement("TD");
                            td.appendChild(document.createTextNode(data[index].id));
                            row.appendChild(td);
                            td = document.createElement("TD");
                            td.appendChild(document.createTextNode(data[index].articleName));
                            row.appendChild(td);
                            td = document.createElement("TD");
                            td.appendChild(document.createTextNode(data[index].debit));
                            row.appendChild(td);
                            td = document.createElement("TD");
                            td.appendChild(document.createTextNode(data[index].credit));
                            row.appendChild(td);
                            td = document.createElement("TD");
                            td.appendChild(document.createTextNode(data[index].create_date));
                            row.appendChild(td);

                            tbody.appendChild(row);
                        }
                    })
                    .catch(function (error) {
                        console.log('Request failed', error);
                    });

            fetch('/api/balance', {
                method: 'get'
            })
                    .then(res => res.json())
                    .then(function (data) {
                        console.log('Get balance request succeeded with JSON response', data);

                        let div = document.createElement("DIV");
                        div.appendChild(document.createTextNode("Balance:"));
                        balance.appendChild(div);
                        div = document.createElement("DIV");
                        div.appendChild(document.createTextNode("Date: " + data.create_date));
                        balance.appendChild(div);
                        div = document.createElement("DIV");
                        div.appendChild(document.createTextNode("Debit: " + data.debit));
                        balance.appendChild(div);
                        div = document.createElement("DIV");
                        div.appendChild(document.createTextNode("Credit: " + data.credit));
                        balance.appendChild(div);
                        div = document.createElement("DIV");
                        div.appendChild(document.createTextNode("Amount: " + data.amount));
                        balance.appendChild(div);
                    })
                    .catch(function (error) {
                        console.log('Request failed', error);
                    });
        }
    }
</script>

</body>
</html>